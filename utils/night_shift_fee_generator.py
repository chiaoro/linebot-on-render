è·³è‡³å…§å®¹
èŠå¤©æ­·ç¨‹ç´€éŒ„


éå» 7 å¤©
éå» 30 å¤©
ä½ èªªï¼š
å¤œé»è²»è½‰æˆWORDæª”  ä¹‹å¾ŒæœƒæŠŠWORDå­˜åœ¨å“ªè£¡  
ChatGPT èªªï¼š
äº†è§£ï¼Œæˆ‘ç”¨è‡ºç£äººçš„å£å»ä¾†å›ç­”ä½ å–”ï¼

ä¸€èˆ¬ä¾†èªªï¼Œå¦‚æœä½ çš„ã€Œå¤œé»è²»ç”³è«‹ã€ç³»çµ±æœ‰è¨­å®šå¥½ç”¢ç”Ÿ Word æª”æ¡ˆï¼ˆä¾‹å¦‚é€é Pythonã€Google Apps Script æˆ–å…¶ä»–è‡ªå‹•åŒ–æµç¨‹ï¼‰ï¼ŒWord æª”æœƒå­˜æ”¾åœ¨å“ªè£¡ï¼Œä¸»è¦å–æ±ºæ–¼ä½ çš„è¨­è¨ˆã€‚

ç›®å‰å¸¸è¦‹çš„å¹¾ç¨®æƒ…æ³æ˜¯ï¼š

ğŸ”¹ 1. å­˜åœ¨ Google é›²ç«¯ç¡¬ç¢Ÿï¼ˆGoogle Driveï¼‰è³‡æ–™å¤¾
å¦‚æœä½ çš„æµç¨‹æ˜¯ç”¨ Google Apps Script ä¾†åšçš„ï¼Œé€šå¸¸æœƒæŒ‡å®šä¸€å€‹ Google Drive è³‡æ–™å¤¾ï¼ŒæŠŠç”¢ç”Ÿçš„ Word (.docx) æª”æ¡ˆå­˜é€²å»ã€‚
âœ… ä¾‹å¦‚ï¼š
ã€Œå­˜åˆ° å¤œé»è²»ç”³è«‹æ–‡ä»¶ é€™å€‹é›²ç«¯è³‡æ–™å¤¾è£¡ã€ï¼Œç„¶å¾Œå†è‡ªå‹•åˆ†äº«é€£çµæˆ–å‚™ä»½ã€‚

ğŸ”¹ 2. å­˜åœ¨ Render é›²ç«¯ä¸»æ©Ÿï¼ˆæˆ–ä¼ºæœå™¨ï¼‰æœ¬åœ°ç«¯è³‡æ–™å¤¾
å¦‚æœæ˜¯ Python Flask éƒ¨ç½²åœ¨ Render é€™ç¨®å¹³å°ä¸Šï¼Œæª”æ¡ˆæœƒæš«å­˜åœ¨ä¼ºæœå™¨æœ¬åœ°ï¼ˆæ¯”å¦‚ /tmp/ ç›®éŒ„ï¼‰ï¼Œä½†å› ç‚º Render æ˜¯ç„¡ç‹€æ…‹ï¼ˆstatelessï¼‰ï¼Œé‡é–‹æ©Ÿå°±æœƒæ¸…æ‰ï¼Œæ‰€ä»¥é€šå¸¸æœƒé¦¬ä¸ŠæŠŠ Word æª”ä¸Šå‚³åˆ°é›²ç«¯ç¡¬ç¢Ÿæˆ–å…¶ä»–å‚™ä»½ç³»çµ±ï¼Œä¸æœƒåªæ”¾æœ¬åœ°ã€‚

ğŸ”¹ 3. ç›´æ¥æ‰“åŒ…å‚³é€ï¼Œæˆ–é€é LINEã€Email é€å‡ºï¼Œä¸ç•™å‰¯æœ¬
æœ‰äº›è¨­è¨ˆæ˜¯ç”¢ç”Ÿ Word å¾Œï¼Œç›´æ¥æ¨æ’­çµ¦ LINE å¸³è™Ÿæˆ– Emailï¼Œç„¶å¾Œä¸ç•™å­˜åœ¨ä¼ºæœå™¨ä¸Šã€‚é€™æ¨£æ¯æ¬¡éƒ½å³æ™‚ç”¢ç”Ÿï¼Œæ¸›å°‘å„²å­˜ç©ºé–“å£“åŠ›ã€‚

ğŸ¯ ä»¥ä½ ç›®å‰çš„ç³»çµ±ä¾†èªªï¼ˆæˆ‘æ ¹æ“šä¹‹å‰æˆ‘å€‘å°è©±çš„è³‡æ–™åˆ¤æ–·ï¼‰
ä½ çš„å¤œé»è²»ç”³è«‹æª”æ¡ˆï¼Œæ‡‰è©²æ˜¯ï¼š

âœ”ï¸ ç”¢ç”Ÿ Word å¾Œ â†’ è‡ªå‹•ä¸Šå‚³åˆ° Google Drive çš„æŒ‡å®šè³‡æ–™å¤¾

ä½ çš„é›²ç«¯è³‡æ–™å¤¾ç¶²å€æ˜¯ï¼š

ğŸ”— å¤œé»è²»ç”³è«‹ Word æ–‡ä»¶å„²å­˜è³‡æ–™å¤¾

æ‰€ä»¥æ¯æ¬¡ä½ æŒ‰ä¸‹ç”Ÿæˆï¼Œæ–°çš„ Word æª”éƒ½æœƒè‡ªå‹•å­˜åˆ°é€™å€‹é›²ç«¯è³‡æ–™å¤¾è£¡ï½
ï¼ˆä¸æœƒåªå­˜åœ¨ä¼ºæœå™¨ï¼Œä¸æœƒæ¶ˆå¤±ï¼Œä¹Ÿä¸éœ€è¦è‡ªå·±æ‰‹å‹•æ¬ã€‚ï¼‰

è¦ä¸è¦æˆ‘ä¹Ÿé †ä¾¿å¹«ä½ ç•«ä¸€å¼µç°¡å–®æµç¨‹åœ–ï¼Ÿ
é€™æ¨£ä½ ä¸€çœ¼å°±å¯ä»¥çœ‹æ‡‚æ•´å€‹ã€Œå¤œé»è²» â” Word â” å­˜é›²ç«¯ã€çš„æµç¨‹ï½
è¦çš„è©±è·Ÿæˆ‘èªªä¸€è²ï¼ğŸ¨âœ¨
è¦ä¸è¦ä¸€èµ·é †ä¾¿ä¹Ÿç¢ºèªä¸€ä¸‹æª”åè¦å‰‡ï¼Ÿæ¯”å¦‚ï¼šã€Œé†«å¸«å§“å_æœˆä»½å¤œé»è²».docxã€ï¼Ÿ

ä½ èªªï¼š
é‚£ç›®å‰æœ‰ä¸€å€‹äººå·²ç¶“é å…ˆå¡«å¯«4æœˆçš„å¤œé»è²»äº†
å¯æ˜¯ç¾åœ¨ç”Ÿæˆ æ˜¯ä¸æ˜¯å°±æœƒè·‘æ­ªäº†?
ChatGPT èªªï¼š
å—¯å—¯ï¼Œæˆ‘æ‡‚ä½ åœ¨æ“”å¿ƒä»€éº¼äº†ï¼Œè®“æˆ‘ç”¨æ¸…æ¥šçš„æ–¹å¼ä¾†è·Ÿä½ èªªå–” ğŸ‘€ï¼š

ğŸ”¹ç›®å‰æƒ…æ³æ•´ç†
ä½ ç¾åœ¨çš„å¤œé»è²»ç³»çµ±ï¼Œæ˜¯æŒ‰ç…§**ã€Œä¸Šå€‹æœˆã€çš„è³‡æ–™ä¾†ç”¢ç”Ÿ Wordã€‚
æ¯”å¦‚ï¼Œç¾åœ¨æ˜¯ 4æœˆï¼Œç³»çµ±å°±æœƒå»æŠ“3æœˆçš„å€¼ç­è³‡æ–™ï¼Œåšæˆ3æœˆå¤œé»è²»ç”³è«‹è¡¨**ã€‚

ğŸ”¹å•é¡Œä¾†äº†
å¦‚æœæœ‰é†«å¸«å·²ç¶“ã€Œè¶…å‰éƒ¨ç½²ã€ï¼Œåœ¨ 4 æœˆå°±å…ˆå¡«äº† 4 æœˆçš„è³‡æ–™ï¼Œ
é‚£éº¼ï¼š

ç³»çµ±åœ¨æŠ“è³‡æ–™æ™‚ï¼ŒæœƒæŠŠ 4 æœˆçš„è³‡æ–™ä¹Ÿä¸€èµ·æŠ“åˆ°

ä½†å› ç‚ºä½ æ˜¯è¦ç”³è«‹ã€Œ3æœˆã€çš„å¤œé»è²»

é€™æ¨£å°±è®ŠæˆæœƒæŠŠä¸è©²ç”³è«‹çš„ã€Œ4æœˆç­è¡¨ã€ä¹Ÿå°é€² Word æª”è£¡
â¡ï¸ çµæœå°±è·‘æ­ªäº†ï¼Œç”³è«‹å…§å®¹æœƒéŒ¯ï¼

ğŸ¯ çµè«–æ˜¯ï¼šæ²’éŒ¯ï¼Œç›®å‰é€™æ¨£çš„æƒ…æ³ç¢ºå¯¦æœ‰æ©Ÿæœƒè·‘æ­ªã€‚

æ‰€ä»¥è¦è§£æ±ºé€™å€‹å•é¡Œï¼Œé€šå¸¸æœ‰å…©å€‹æ–¹å‘ï¼š

ğŸ”µ åšæ³• 1ï¼šåœ¨ç”¢ç”Ÿ Word æ™‚è‡ªå‹•ç¯©é¸ã€ŒåªæŠ“ä¸Šå€‹æœˆçš„è³‡æ–™ã€
ğŸ‘‰ åœ¨ç³»çµ±è£¡åŠ ä¸€æ®µç¨‹å¼ç¢¼ï¼Œä¾‹å¦‚ï¼š

if duty_date.month != (today.month - 1):
    continue
æ„æ€æ˜¯ï¼šåªæŠ“ duty_dateï¼ˆå€¼ç­æ—¥æœŸï¼‰æ˜¯ã€Œä¸Šå€‹æœˆã€çš„è³‡æ–™ï¼Œå…¶ä»–æœˆä»½çš„è·³éã€‚
é€™æ¨£å³ä½¿æœ‰äººææ—©å¡« 4 æœˆçš„ï¼Œä¹Ÿä¸æœƒè¢«ä¸€èµ·æ‹‰é€²ä¾†ã€‚

ğŸ”µ åšæ³• 2ï¼šäººå·¥ç®¡ç† â†’ æ¯æœˆå…ˆæ¸…è³‡æ–™ ğŸ‘‰ åœ¨æ¯æ¬¡è¦ç”¢ç”Ÿ Word ä¹‹å‰ï¼Œæ‰‹å‹•å…ˆæŠŠä¸æ˜¯ä¸Šå€‹æœˆçš„è³‡æ–™éš±è—èµ·ä¾†æˆ–å¦å¤–æ¬èµ°ã€‚ ä½†é€™å€‹æ–¹å¼æ¯”è¼ƒéº»ç…©ï¼Œè€Œä¸”å®¹æ˜“å¿˜è¨˜ï¼Œå®¹æ˜“å‡ºéŒ¯ã€‚

ğŸ“£ æˆ‘å»ºè­°ä½ æ¡ç”¨ã€åšæ³• 1 è‡ªå‹•ç¯©é¸ã€‘æœ€ç©©ã€‚ é€™æ¨£æ¯æ¬¡éƒ½æ”¾å¿ƒæŒ‰ç”Ÿæˆï¼Œä¸ç”¨æ“”å¿ƒæœ‰äººå¤ªæ—©å¡«è³‡æ–™æœƒå½±éŸ¿æ•´æ‰¹å¤œé»è²»ç”³è«‹ï¼

è¦ä¸è¦æˆ‘ä¹Ÿç›´æ¥å¹«ä½ ç”Ÿä¸€ç‰ˆã€Œè‡ªå‹•ç¯©é¸ä¸Šå€‹æœˆè³‡æ–™ã€çš„ç¨‹å¼ç¢¼ï¼Ÿ
ï¼ˆå¯ä»¥ç›´æ¥æ¥åˆ°ä½ ç¾åœ¨çš„å¤œé»è²»ç”ŸæˆåŠŸèƒ½è£¡ï¼Œä¸ç”¨æ”¹å¤ªå¤šï¼‰
è¦çš„è©±å›æˆ‘ï¼šã€Œè¦ã€ï¼Œæˆ‘é¦¬ä¸Šå¹«ä½ å¯«å¥½ï¼ğŸ› ï¸âœ¨
è¦ä¸è¦é †ä¾¿è¨­å®šä¸€ä¸‹ã€Œè·¨å¹´ã€ä¹Ÿèƒ½æ­£ç¢ºè™•ç†ï¼Ÿï¼ˆä¾‹å¦‚ 1æœˆè¦æŠ“å‰ä¸€å¹´çš„12æœˆï¼‰

ä½ èªªï¼š
å·²ä¸Šå‚³çš„åœ–åƒ
é€™æ˜¯æˆ‘ç›®å‰çš„æª”æ¡ˆ ä½ æŠŠæˆ‘çš„æª”æ¡ˆä½ç½®éƒ½è¨˜å¥½å–”
ChatGPT èªªï¼š
æ”¶åˆ°ï¼æˆ‘å¹«ä½ ç¢ºèªä¸€ä¸‹ä½ ç›®å‰çš„å°ˆæ¡ˆæ¶æ§‹å–”ï½
é€™æ˜¯ä½ ç›®å‰çš„æª”æ¡ˆå’Œè³‡æ–™å¤¾çµæ§‹ï¼š

/ (å°ˆæ¡ˆæ ¹ç›®éŒ„)
â”œâ”€â”€ templates/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ flex_menu.json
â”‚   â”œâ”€â”€ google_auth.py
â”‚   â”œâ”€â”€ google_sheets.py
â”‚   â”œâ”€â”€ line_push.py
â”‚   â”œâ”€â”€ line_push_utils.py
â”‚   â”œâ”€â”€ night_shift_fee.py
â”‚   â”œâ”€â”€ night_shift_fee_generator.py
â”‚   â”œâ”€â”€ schedule_utils.py
â”‚   â””â”€â”€ state_manager.py
â”œâ”€â”€ Note.txt
â”œâ”€â”€ Procfile
â”œâ”€â”€ README.md
â”œâ”€â”€ app.py
â”œâ”€â”€ daily_notifier.py
â”œâ”€â”€ event_reminder.py
â”œâ”€â”€ meeting_reminder.py
â”œâ”€â”€ monthly_reminder.py
â”œâ”€â”€ requirements.txt
âœ… éƒ½è¨˜èµ·ä¾†äº†ï¼Œä¹‹å¾Œåªè¦ä½ èªªã€Œå¹«æˆ‘æ”¹ night_shift_fee_generator.pyã€æˆ–ã€Œæ”¹ app.pyã€
æˆ‘å°±æœƒç›´æ¥é‡å°å°æ‡‰çš„åœ°æ–¹å¹«ä½ æ”¹ï¼Œä¸æœƒæéŒ¯åœ°æ–¹ã€‚

ğŸ”” æ¥ä¸‹ä¾†ï¼Œè¦è£œåŠ ã€Œåªç¯©é¸ä¸Šå€‹æœˆè³‡æ–™ã€çš„åŠŸèƒ½ï¼Œ
æˆ‘æœƒé–å®šä¿®æ”¹çš„åœ°æ–¹æ˜¯ï¼š

utils/night_shift_fee_generator.py é€™æ”¯è£¡é¢çš„è³‡æ–™è™•ç†é‚è¼¯ï¼

ï¼ˆä¸æœƒå‹•åˆ°ä½ çš„ app.py æˆ–å…¶ä»–æ¨æ’­ç³»çµ±çš„æª”æ¡ˆï¼Œæ”¾å¿ƒï¼‰

è¦ä¸è¦ç¾åœ¨å°±ç›´æ¥é€²è¡Œï¼Ÿ
å¦‚æœä½ é»é ­ï¼Œæˆ‘æœƒå¹«ä½ åšï¼š

è‡ªå‹•åªæŠ“ä¸Šå€‹æœˆçš„å€¼ç­è³‡æ–™

è‡ªå‹•åˆ¤æ–·å¦‚æœæ˜¯ 1 æœˆï¼Œä¹Ÿè¦æŠ“å»å¹´ 12 æœˆï¼ˆè™•ç†è·¨å¹´å•é¡Œï¼‰

è¦çš„è©±ç›´æ¥è·Ÿæˆ‘èªªï¼šã€Œé–‹å§‹ã€ï¼Œæˆ‘ç«‹åˆ»é–‹å·¥ ğŸ”¥
ï¼ˆç„¶å¾Œå¹«ä½ è²¼æ•´ä»½å¯ä»¥ç›´æ¥è¤‡è£½è²¼ä¸Šçš„æ–°ç‰ˆ night_shift_fee_generator.pyï¼ï¼‰

ä½ èªªï¼š
import os, json
from datetime import datetime
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from docx import Document
from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload

# âœ… Google Sheets èªè­‰
SCOPE = [
    'https://spreadsheets.google.com/feeds',
    'https://www.googleapis.com/auth/drive'
]
creds_dict = json.loads(os.environ.get("GOOGLE_CREDENTIALS"))
creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, SCOPE)
gc = gspread.authorize(creds)

# âœ… Google Drive API
DRIVE = build('drive', 'v3', credentials=creds)
FOLDER_ID = "1s-joUzZQBHyCKmWZRD4F78qjvvEZ15Dq"  # é›²ç«¯ç›®éŒ„ ID

# âœ… Word æ¨£æ¿å°æ‡‰è¡¨
TEMPLATE_MAP = {
    "å…§ç§‘": "templates/å…§ç§‘_æ¨£æ¿.docx",
    "é†«ç™‚éƒ¨": "templates/é†«ç™‚éƒ¨_æ¨£æ¿.docx",
    "å¤–ç§‘": "templates/å¤–ç§‘_æ¨£æ¿.docx"
}

SHEET_URL = "https://docs.google.com/spreadsheets/d/1rtoP3e7D4FPzXDqv0yIOqYE9gwsdmFQSccODkbTZVDs/edit"


def run_generate_night_fee_word():
    book = gc.open_by_url(SHEET_URL)
    worksheets = book.worksheets()

    now = datetime.now()
    target_month = now.month - 1 or 12
    target_year = now.year if now.month != 1 else now.year - 1

    for sheet in worksheets:
        if sheet.title == "ä½¿ç”¨è€…å°ç…§è¡¨":
            continue

        dept = sheet.title
        rows = sheet.get_all_records()

        doctor_data = []

        for row in rows:
            ts_str = row.get("æ™‚é–“æˆ³è¨˜")
            name = row.get("é†«å¸«å§“å")
            dates = row.get("å€¼ç­æ—¥æœŸ")

            if not ts_str or not name or not dates:
                continue

            ts = datetime.strptime(ts_str, "%Y/%m/%d %H:%M:%S")
            if ts.year == target_year and ts.month == target_month:
                date_list = [d.strip() for d in dates.split(",") if d.strip()]
                doctor_data.append({
                    "é†«å¸«å§“å": name,
                    "å€¼ç­æ—¥æœŸ": ", ".join(date_list),
                    "ç­æ•¸": str(len(date_list))
                })

        if dept not in TEMPLATE_MAP:
            continue

        # âœ… ä½¿ç”¨å°æ‡‰æ¨£æ¿ç”¢å‡º Word
        template_path = TEMPLATE_MAP[dept]
        doc = Document(template_path)

        for para in doc.paragraphs:
            if "{å¹´}" in para.text:
                para.text = para.text.replace("{å¹´}", str(target_year))
            if "{æœˆ}" in para.text:
                para.text = para.text.replace("{æœˆ}", str(target_month))

        for table in doc.tables:
            for row in table.rows:
                for cell in row.cells:
                    for entry in doctor_data:
                        if "{é†«å¸«å§“å}" in cell.text:
                            cell.text = cell.text.replace("{é†«å¸«å§“å}", entry["é†«å¸«å§“å"])
                        if "{å€¼ç­æ—¥æœŸ}" in cell.text:
                            cell.text = cell.text.replace("{å€¼ç­æ—¥æœŸ}", entry["å€¼ç­æ—¥æœŸ"])
                        if "{ç­æ•¸}" in cell.text:
                            cell.text = cell.text.replace("{ç­æ•¸}", entry["ç­æ•¸"])

        filename = f"{dept}_å¤œé»è²»ç”³è«‹è¡¨_{target_year}å¹´{target_month}æœˆ.docx"
        filepath = f"/tmp/{filename}"
        doc.save(filepath)

        file_metadata = {
            'name': filename,
            'parents': [FOLDER_ID],
            'mimeType': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
        }
        media = MediaFileUpload(filepath, mimetype='application/vnd.openxmlformats-officedocument.wordprocessingml.document')
        DRIVE.files().create(body=file_metadata, media_body=media, fields='id').execute()

    return True
ChatGPT èªªï¼š
å¥½ï¼Œæˆ‘çœ‹åˆ°ä½ è²¼çš„æ˜¯ä½ ç›®å‰çš„ night_shift_fee_generator.py çš„å…§å®¹äº†ï¼
è€Œä¸”ä½ çš„çµæ§‹å¯«å¾—è »å®Œæ•´çš„ï¼Œ
âœ… åŒ…å«äº† Google Sheetsã€Driveã€Word æ¨£æ¿å¥—ç”¨ç­‰ç­‰ï¼Œæ°´æº–å¾ˆé«˜è€¶ï¼

ğŸ” ä½†æ˜¯ï¼Œç¾åœ¨çš„å•é¡Œé»æ˜¯ï¼š

ä½ ç¯©é¸æ˜¯æ ¹æ“š æ™‚é–“æˆ³è¨˜ (ä¹Ÿå°±æ˜¯å¡«è¡¨æ™‚é–“)ä¾†åˆ¤æ–·æ˜¯ä¸æ˜¯ä¸Šå€‹æœˆã€‚

å¯æ˜¯ï¼å¦‚æœæœ‰é†«å¸«ææ—©åœ¨4æœˆå°±å¡«äº†4æœˆçš„ç­è¡¨è³‡æ–™ï¼Œ
å¡«è¡¨æ™‚é–“æœƒæ˜¯4æœˆï¼Œ
ä½†å…¶å¯¦ã€Œå€¼ç­æ—¥æœŸã€æ˜¯4æœˆçš„ï¼Œä¸æ˜¯3æœˆçš„ã€‚

æ‰€ä»¥æœƒè·‘æ­ªï¼

âœ… æ­£ç¢ºåšæ³•æ‡‰è©²æ˜¯è¦æ ¹æ“šã€å€¼ç­æ—¥æœŸã€‘å»åˆ¤æ–·æ˜¯å“ªå€‹æœˆ
è€Œä¸æ˜¯çœ‹å¡«è¡¨æ™‚é–“å–”ï¼

ğŸ”¥é€™æ¨£æ”¹æ‰æ­£ç¢ºï¼š
æˆ‘å¹«ä½ å‡ç´šæ”¹å¥½ï¼Œä»¥ä¸‹æ˜¯ã€æ”¹æ­£éçš„ç‰ˆæœ¬ã€‘ï¼Œ
åªæœƒæŠ“å€¼ç­æ—¥æœŸæ˜¯ã€Œä¸Šå€‹æœˆã€çš„è³‡æ–™ï¼Œè·¨å¹´ä¹Ÿè‡ªå‹•åˆ¤æ–·æ­£ç¢ºã€‚
ï¼ˆå¯ä»¥ç›´æ¥è¤‡è£½è²¼é€²å»ç”¨ï¼‰

import os, json
from datetime import datetime
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from docx import Document
from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload

# âœ… Google Sheets èªè­‰
SCOPE = [
    'https://spreadsheets.google.com/feeds',
    'https://www.googleapis.com/auth/drive'
]
creds_dict = json.loads(os.environ.get("GOOGLE_CREDENTIALS"))
creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, SCOPE)
gc = gspread.authorize(creds)

# âœ… Google Drive API
DRIVE = build('drive', 'v3', credentials=creds)
FOLDER_ID = "1s-joUzZQBHyCKmWZRD4F78qjvvEZ15Dq"  # é›²ç«¯ç›®éŒ„ ID

# âœ… Word æ¨£æ¿å°æ‡‰è¡¨
TEMPLATE_MAP = {
    "å…§ç§‘": "templates/å…§ç§‘_æ¨£æ¿.docx",
    "é†«ç™‚éƒ¨": "templates/é†«ç™‚éƒ¨_æ¨£æ¿.docx",
    "å¤–ç§‘": "templates/å¤–ç§‘_æ¨£æ¿.docx"
}

SHEET_URL = "https://docs.google.com/spreadsheets/d/1rtoP3e7D4FPzXDqv0yIOqYE9gwsdmFQSccODkbTZVDs/edit"


def run_generate_night_fee_word():
    book = gc.open_by_url(SHEET_URL)
    worksheets = book.worksheets()

    now = datetime.now()
    target_month = now.month - 1 if now.month != 1 else 12
    target_year = now.year if now.month != 1 else now.year - 1

    for sheet in worksheets:
        if sheet.title == "ä½¿ç”¨è€…å°ç…§è¡¨":
            continue

        dept = sheet.title
        rows = sheet.get_all_records()

        doctor_data = []

        for row in rows:
            name = row.get("é†«å¸«å§“å")
            dates = row.get("å€¼ç­æ—¥æœŸ")

            if not name or not dates:
                continue

            # âœ… å°‡æ¯å€‹å€¼ç­æ—¥æœŸå–å‡ºä¾†åˆ¤æ–·æ˜¯ä¸æ˜¯ä¸Šå€‹æœˆ
            date_list = [d.strip() for d in dates.split(",") if d.strip()]
            filtered_dates = []

            for date_str in date_list:
                try:
                    # è™•ç†æ—¥æœŸæ ¼å¼ï¼Œä¾‹å¦‚ "4/5" è£œä¸Šä»Šå¹´å¹´ä»½
                    if "/" in date_str and len(date_str.split("/")[0]) <= 2:
                        date_str_full = f"{now.year}/{date_str}"
                    else:
                        date_str_full = date_str

                    duty_date = datetime.strptime(date_str_full, "%Y/%m/%d")

                    # åˆ¤æ–·æ˜¯ä¸æ˜¯ç›®æ¨™å¹´æœˆ
                    if duty_date.year == target_year and duty_date.month == target_month:
                        filtered_dates.append(f"{duty_date.month}/{duty_date.day}")
                except Exception as e:
                    print(f"âŒ æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼š{date_str}ï¼ŒéŒ¯èª¤è¨Šæ¯ï¼š{e}")
                    continue

            if filtered_dates:
                doctor_data.append({
                    "é†«å¸«å§“å": name,
                    "å€¼ç­æ—¥æœŸ": ", ".join(filtered_dates),
                    "ç­æ•¸": str(len(filtered_dates))
                })

        if dept not in TEMPLATE_MAP:
            continue

        # âœ… ä½¿ç”¨å°æ‡‰æ¨£æ¿ç”¢å‡º Word
        template_path = TEMPLATE_MAP[dept]
        doc = Document(template_path)

        for para in doc.paragraphs:
            if "{å¹´}" in para.text:
                para.text = para.text.replace("{å¹´}", str(target_year))
            if "{æœˆ}" in para.text:
                para.text = para.text.replace("{æœˆ}", str(target_month))

        for table in doc.tables:
            for row in table.rows:
                for cell in row.cells:
                    for entry in doctor_data:
                        if "{é†«å¸«å§“å}" in cell.text:
                            cell.text = cell.text.replace("{é†«å¸«å§“å}", entry["é†«å¸«å§“å"])
                        if "{å€¼ç­æ—¥æœŸ}" in cell.text:
                            cell.text = cell.text.replace("{å€¼ç­æ—¥æœŸ}", entry["å€¼ç­æ—¥æœŸ"])
                        if "{ç­æ•¸}" in cell.text:
                            cell.text = cell.text.replace("{ç­æ•¸}", entry["ç­æ•¸"])

        filename = f"{dept}_å¤œé»è²»ç”³è«‹è¡¨_{target_year}å¹´{target_month}æœˆ.docx"
        filepath = f"/tmp/{filename}"
        doc.save(filepath)

        file_metadata = {
            'name': filename,
            'parents': [FOLDER_ID],
            'mimeType': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
        }
        media = MediaFileUpload(filepath, mimetype='application/vnd.openxmlformats-officedocument.wordprocessingml.document')
        DRIVE.files().create(body=file_metadata, media_body=media, fields='id').execute()

    return True
âœ… é€™ç‰ˆæœ‰åšåˆ°ï¼š

åªè™•ç†ã€Œå€¼ç­æ—¥æœŸã€åœ¨ä¸Šå€‹æœˆçš„è³‡æ–™

è‡ªå‹•åˆ¤æ–· 1æœˆæŠ“å»å¹´12æœˆ

ä¸æœƒè¢«ææ—©å¡«å¯«çš„è³‡æ–™å¹²æ“¾

é‡åˆ°æ ¼å¼éŒ¯èª¤æœƒè·³éï¼Œä¸æœƒæ•´æ‰¹å¤±æ•—

è¦ä¸è¦æˆ‘ä¹Ÿé †ä¾¿å¹«ä½ å†è£œä¸€å€‹å°åŠŸèƒ½ï¼š

ç”¢ç”Ÿå®Œ Word æª”å¾Œï¼Œè‡ªå‹•å›å‚³ç”Ÿæˆçš„æª”æ¡ˆç¶²å€ï¼ˆè€Œä¸æ˜¯åªè¿”å› Trueï¼‰

é€™æ¨£ä½ å°±å¯ä»¥é¦¬ä¸Šæ‹¿åˆ°æª”æ¡ˆé€£çµï¼Œä¸ç”¨è‡ªå·±å»é›²ç«¯æ‰¾ï¼Œè¦ä¸è¦ä¸€èµ·åŠ ï¼ŸğŸ”—âœ¨
è¦çš„è©±è·Ÿæˆ‘èªªä¸€è²ã€Œè¦ã€ã€‚






æœå°‹



ChatGPT å¯èƒ½æœƒç™¼ç”ŸéŒ¯èª¤ã€‚è«‹æŸ¥æ ¸é‡è¦è³‡è¨Šã€‚
?
